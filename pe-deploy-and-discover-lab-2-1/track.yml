slug: pe-deploy-and-discover-lab-2-1
id: y8mpb4sleibk
type: sandbox
title: 'PE Deploy and Discover - Lab 2.1: Configure Agent Certificate Autosigning'
teaser: Learn how to set up autosigning so that you can automate agent installation on new nodes.
description: |-
  # We're putting the finishing touches on this BETA Puppet Practice Lab — go ahead and take a peek!

  Please help us find any bugs that need to be zapped and share your feedback for improving this learning experience by clicking the **Bug Zapper** tab at the top of each challenge and completing the short survey.

  We welcome your suggestions and value your feedback. If you have additional comments or suggestions after completing this BETA Puppet Practice Lab, please [reach out to us directly](mailto:education@puppet.com).
  ___

  **What you'll learn**

  In this lab, you'll learn how to configure Puppet policy-based autosigning to securely automate Puppet agent installation on new nodes, eliminating a mundane task and making agent deployment faster.

  **Prerequisites**

  None

  **Before you start**

  Keep an eye on the clock. You have 30 minutes to complete this lab. After 30 minutes, your learning environment expires and your work will not be saved. If you haven't completed the lab, you can simply restart it. Click **Start track** when you're ready to begin.
icon: https://storage.googleapis.com/instruqt-images/bz-smallicon-1.png
tags: []
owner: puppet
developers:
- greg.larkin@puppet.com
- thomas.chisholm@puppet.com
- tara.swenson@puppet.com
- catherine.trinkwon@puppet.com
private: true
published: true
show_timer: true
challenges:
- slug: configure-autosigning
  id: jfhy7qsxgss1
  type: challenge
  title: Configure autosigning
  teaser: Install the Puppet agent with autosigning enabled.
  notes:
  - type: text
    contents: |-
      In this lab, you will:

      * Configure the primary server to enable policy-based autosigning, enabling new nodes to be automatically added and managed by the primary server.

      In this example, the policy includes a simple check for a password. More complex policies might include an external database lookup or requiring other information to be passed in with the certificate request.

      * Run the agent installation script and automatically sign the agent's certificate by providing a challenge password.

      Click **Start** when you're ready to begin.
  assignment: |
    1. On the **Primary Server** tab, navigate to:
    ```
    cd /etc/puppetlabs/puppet
    ```
    2. Create and edit the autosign.rb script:
    ```
    vim autosign.rb
    ```
    3. Copy the code below into the file.

    To do this, type `:set paste`, press **Enter**, and then press `i`. Click the code below to copy it, and paste it from the clipboard. Then, save and exit by pressing `ESC` and typing `:wq`.
    ```
    #!/opt/puppetlabs/puppet/bin/ruby
    #
    # A note on logging:
    #   This script's stderr and stdout are only shown at the DEBUG level
    #   of the server's logs. This means you won't see the error messages
    #   in puppetserver.log by default. All you'll see is the exit code.
    #
    #   https://docs.puppet.com/puppet/latest/ssl_autosign.html#policy-executable-api
    #
    # Exit Codes:
    #   0 - A matching challengePassword was found.
    #   1 - No challengePassword was found.
    #   2 - The wrong challengePassword was found.
    #
    require 'puppet/ssl'

    csr = Puppet::SSL::CertificateRequest.from_s(STDIN.read)
    psk = File.read('/etc/puppetlabs/puppet/psk').chomp.strip

    if pass = csr.custom_attributes.find do |attribute|
         ['challengePassword', '1.2.840.113549.1.9.7'].include? attribute['oid']
       end
    else
      puts 'No challengePassword found. Rejecting certificate request.'
      exit 1
    end

    if pass['value'] == psk
      exit 0
    else
      puts "challengePassword does not match: #{pass['value']}"
      exit 2
    end
    ```

    4. Make the script executable and set the owner/group to `pe-puppet:pe-puppet`. To save time, you can click the code below to copy it, and then paste it on the command line:
    ```
    chmod 700 /etc/puppetlabs/puppet/autosign.rb
    chown pe-puppet:pe-puppet /etc/puppetlabs/puppet/autosign.rb
    ```

    5. Create and edit the pre-shared key (PSK) file:
    ```
    vim psk
    ```

    6. Copy the following pre-shared key into the file.
    Type `:set paste`, press **Enter**, and then press `i`. Click the code below to copy it, and paste it from the clipboard. Then, press `ESC` and type `:wq`.

    ```
    PASSWORD_FOR_AUTOSIGNER_SCRIPT
    ```

    7. Lock down the key file permissions and set the owner/group to `pe-puppet:pe-puppet`. On the **Primary Server** tab, run:

    ```
    chmod 600 /etc/puppetlabs/puppet/psk
    chown pe-puppet:pe-puppet /etc/puppetlabs/puppet/psk
    ```

    8. Configure the primary server to enable autosigning with `autosign.rb` by running:

    ```
    puppet config set autosign /etc/puppetlabs/puppet/autosign.rb --section server
    ```

    9. Restart the primary server:

    ```
    sudo service pe-puppetserver restart
    ```

    10. On the **Linux Agent** tab, install the Puppet agent by using the installation script with the `custom_attributes:challengePassword` parameter:

    ```
    uri='https://puppet:8140/packages/current/install.bash'
    curl --insecure "$uri" | bash -s custom_attributes:challengePassword=PASSWORD_FOR_AUTOSIGNER_SCRIPT
    ```

    11. When the installation is complete, switch to the **PE Console** tab and log in with username `admin` and password `puppetlabs`.

    12. From the console sidebar, navigate to the **Nodes** page and confirm that the `nixagent` node is shown in the node list, which means that the agent's certificate was signed automatically and the node is now managed by PE.

    13. Click the `nixagent` node, and on the **Facts** tab, explore the facts about the machine, such as OS version, number of CPUs, and so on.

    Congratulations! You installed the Puppet agent with autosigning enabled.

    **Find bugs or have feedback? Click the Bug Zapper tab near the top of the page and let us know!**

    To close this lab, click **Next**.
  tabs:
  - title: Primary Server
    type: terminal
    hostname: puppet
  - title: Linux Agent
    type: terminal
    hostname: nixagent
  - title: PE Console
    type: service
    hostname: puppet
    port: 443
  - title: "Bug Zapper \U0001F99F⚡"
    type: website
    hostname: puppet
    url: https://docs.google.com/forms/d/e/1FAIpQLSe6525nHrz5FRpniKPvllcYfyDOQRl6St9wvW-wKErvmt8RSg/viewform?embedded=true
  difficulty: basic
  timelimit: 1200
checksum: "15008870580679861322"
