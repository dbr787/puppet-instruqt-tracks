slug: pe-deploy-and-discover-lab-3-2
id: 6iykmwi1khah
type: track
title: Establish Server Roles by Reinstalling Agents with Trusted Facts
teaser: Purge the agent from your nodes and reinstall it with Puppet's trusted facts.
description: |-
  **What you'll learn**

  In this, lab, you'll purge the Puppet agent from your nodes, and then reinstall the agent on each node to include Puppet's pp_role and pp_datacenter trusted facts.

  Because trusted facts are extracted from the agent certificate, the data is immutable, providing a higher level of security for your nodes. You can use the data from facts to classify (group) nodes so that you can get configuration and performance data for a specific group of nodes.


  **Prerequisites**

  This lab builds on concepts introduced in other PE Deploy and Discover labs. You might find it helpful to complete these labs first:
   - [Identify Your Nodes Using External Facts](https://play.instruqt.com/puppet/invite/7njh4szvazdy)
   - [Identify Server Roles by Using Package Data Collection](https://play.instruqt.com/puppet/invite/qbye99iuacew)

  ---

  **Keep an eye on the clock**

  ![30 minute lab](https://storage.googleapis.com/instruqt-images/Clocks%20for%20Track%20Duration/30min100.png) The virtual learning environment will stay up for 60 minutes, however, **this lab should only take about 30 minutes** to complete. When your learning environment expires, your work will not be saved. If you haven't completed the lab, you can simply restart it.

  Click **Start track** when you're ready to begin.
icon: https://storage.googleapis.com/instruqt-frontend/img/tracks/puppet.png
tags:
- ""
owner: puppet
developers:
- thomas.chisholm@puppet.com
- tara.swenson@puppet.com
- catherine.trinkwon@puppet.com
- greg.larkin@puppet.com
private: true
published: true
show_timer: true
challenges:
- slug: working-with-puppets-trusted-facts
  id: 0fmim6wrx8d8
  type: challenge
  title: Working with Puppet's trusted facts
  teaser: Purge the agents and reinstall them with trusted facts.
  notes:
  - type: text
    contents: |-
      In this lab, you'll learn how to add trusted facts to agents. You will:

      1. Manually uninstall the agents and purge the nodes from the primary server.
      2. Reinstall your agents with two trusted facts: `pp_role` and `pp_datacenter`
      3. Re-sign the agent certificate with the trusted facts.

      This lab environment takes about 7 minutes to spin up. When the **Start** button appears, click it to begin.
  assignment: "*If you prefer to use Windows, you can jump to the [Windows instructions](#windows).*\n\n<a name=\"linux\"><img src=\"https://storage.googleapis.com/instruqt-images/graphic-linux.png\"></a>\n# Uninstall Linux agents\n\n⚠️ **Important:** The ****Linux Agent 1**** and ****Linux Agent 2**** tabs represent Linux nodes. Complete the following steps ****on each Linux agent node****.\n\n1. Retrieve the nodes' `certname` by running the following command on each node:<br><br>\n    ```\n    puppet config print certname\n    ```\n    \U0001F3C6 **Extra credit:** Alternatively, see if you can find the certnames in the **PE Console**. Log in with user `admin` and password `puppetlabs`.\n\n2. Copy the certnames to a local text editor of your choice — you'll need them later in the lab.\n\n3. Retire the nodes by running the *nix agent uninstall script on each node: <br><br>\n    ```\n    /opt/puppetlabs/bin/puppet-enterprise-uninstaller -y -pd\n    ```\n\n4. Verify that the Puppet directory has been removed by running the following command on each node:<br><br>\n    ```\n    ls /etc/puppetlabs\n    ```\n    ✔️ **Result:** The output confirms that the agent no longer exists.\n\n    ✏️ **Note:** Remember to complete these steps on each Linux agent node before continuing to the next section.\n\n---\n\n# Remove nodes from the primary server\n\n\U0001F4AD **Why do this?**<br>\n    Uninstalling the agent from a node does not remove the node from management by the primary server. You must also purge the node.\n\n1. ![switch tabs](https://storage.googleapis.com/instruqt-images/Instruct%20Icons/icon_switch_tabs_white_32.png) Switch to the **Primary Server** tab to run commands on the primary server.\n\n2. Purge both Linux nodes by running the following command ****twice****, each time replacing `<CERTNAME>` with the certnames you gathered in a previous step:<br><br>\n    ```\n    puppet node purge <CERTNAME>\n    ```\n    ✔️ **Result:** In the output, notice the message: `Node <CERTNAME> was purged.`<br><br>\n    ✏️ **Note:** Remember to run this command for each Linux node before continuing to the next section.\n\n---\n\n# Reinstall Linux agents with trusted facts and an autosign password\n\nIn the following steps, replace `<DATACENTER>` and `<ROLE>` in the script with the correct trusted fact for each node:\n\n|   | Data Center | Role |\n|-| :-----------: | :---------------: |\n| ****Linux Agent 1**** | `dc-west` | `cmsweb`|\n| ****Linux Agent 2**** | `dc-west` | `cmsloadbalancer`|\n| ****Windows Agent**** | `dc-east` | `ecommerce` |\n\n1. ![switch tabs](https://storage.googleapis.com/instruqt-images/Instruct%20Icons/icon_switch_tabs_white_32.png) Switch to the ****Linux Agent 1**** tab.\n\n2. Install an agent on the node by running the following installation script.<br><br>⚠️ **Important:** Remember to replace `<DATACENTER>` and `<ROLE>` with data from the table above.<br><br>\n    ```\n    uri='https://puppet:8140/packages/current/install.bash'\n    curl --insecure \"$uri\" | sudo bash -s custom_attributes:challengePassword=PASSWORD_FOR_AUTOSIGNER_SCRIPT extension_requests:pp_role=<ROLE> extension_requests:pp_datacenter=<DATACENTER>\n    ```\n3. ![switch tabs](https://storage.googleapis.com/instruqt-images/Instruct%20Icons/icon_switch_tabs_white_32.png) Switch to the ****Linux Agent 2**** tab and repeat step 2 above.\n\n4. ![switch tabs](https://storage.googleapis.com/instruqt-images/Instruct%20Icons/icon_switch_tabs_white_32.png) Switch to the ****PE Console**** tab. Hit refresh inside the PE Console tab to see attached nodes.\n\n5. Click on the Linux node names to view the trusted facts for each new node.\n\n<br>\U0001F388 **Congratulations!** You uninstalled the agent from your Linux nodes and purged them from the primary server so that you can reuse their node licenses. You then securely assigned each server's role and data center in your environment by installing the Puppet agent with trusted facts and provided an autosign password to enable certificate signing so that primary server can authenticate the agent.\n\n---\n\n\n<a name=\"windows\"><img src=\"https://storage.googleapis.com/instruqt-images/graphic-windows.png\"></a>\n\n # Uninstall Windows agents\n\n1. ![switch tabs](https://storage.googleapis.com/instruqt-images/Instruct%20Icons/icon_switch_tabs_white_32.png) Switch to the **Windows Agent** tab.\n\n1. Open a PowerShell terminal: **Start** —> **Windows Powershell** —> **Windows Powershell**\n\n1. Retrieve the node's `certname` by running the following command:<br><br>\n    ```\n    puppet config print certname\n    ```\n    \U0001F3C6 **Extra credit:** Alternatively, see if you can find the certname in the **PE Console**. Log in with user `admin` and password `puppetlabs`.\n\n1. Copy the certname to a local text editor of your choice — you'll need it later in the lab.\n\n1. Launch the **Windows Add or Remove Programs** interface by running the following command in PowerShell:<br><br>\n    ```\n    appwiz\n    ```\n\n1. Right-click __Puppet Agent (64-bit)__, select __Uninstall__, and follow the prompts to uninstall. Click OK on the dialogue box that says a reboot is necessary, but do not reboot.<br><br>✏️ **Note:** Uninstalling the agent removes the Puppet program directory, the agent service, and all related registry keys. This might take a couple of minutes.<br><br>⚠️ **Important:** The `data` directory remains intact, including all SSL keys. Completely remove the agent from the node in the next step.\n\n1. In the PowerShell terminal, run the following command:<br><br>\n    ```\n    remove-item C:\\ProgramData\\PuppetLabs\\puppet -Recurse -Confirm:$false\n    ```\n# Remove the node from the primary server\n\n\U0001F4AD **Why do this?**<br>\n    Uninstalling the agent from a node does not remove the node from management by the primary server. You must also purge the node.\n\n1. ![switch tabs](https://storage.googleapis.com/instruqt-images/Instruct%20Icons/icon_switch_tabs_white_32.png) Switch to the **Primary Server** tab to run commands on the primary server.\n\n2. Purge the Windows node by running the following command, replacing `<CERTNAME>` with the certname you gathered in a previous step:<br><br>\n    ```\n    puppet node purge <CERTNAME>\n    ```\n    ✔️ **Result:** In the output, notice the message: `Node <CERTNAME> was purged.`<br><br>\n\n---\n\n# Reinstall Windows agents with trusted facts and an autosign password\n\nIn the following steps, replace `<DATACENTER>` and `<ROLE>` in the script with the correct trusted fact for the Windows node:\n\n|   | Data Center | Role |\n|-| :-----------: | :---------------: |\n| ****Linux Agent 1**** | `dc-west` | `cmsweb`|\n| ****Linux Agent 2**** | `dc-west` | `cmsloadbalancer`|\n| ****Windows Agent**** | `dc-east` | `ecommerce` |\n\n\n1. ![switch tabs](https://storage.googleapis.com/instruqt-images/Instruct%20Icons/icon_switch_tabs_white_32.png) Switch to the ****Windows Agent**** tab.\n\n1. Install an agent by using the following installation script, passing in the corresponding role and data center for the last command. Run the following four commands one at a time:<br><br>\n    Command 1\n    ```\n    [Net.ServicePointManager]::ServerCertificateValidationCallback = {$true};\n    ```\n    Command 2\n    ```\n    $webClient = New-Object System.Net.WebClient;\n    ```\n    Command 3\n    ```\n    $webClient.DownloadFile('https://puppet:8140/packages/current/install.ps1', 'install.ps1');\n    ```\n    Command 4\n    ```\n    .\\install.ps1 custom_attributes:challengePassword=PASSWORD_FOR_AUTOSIGNER_SCRIPT extension_requests:pp_role=<ROLE> extension_requests:pp_datacenter=<DATACENTER>\n    ```\n\n1. ![switch tabs](https://storage.googleapis.com/instruqt-images/Instruct%20Icons/icon_switch_tabs_white_32.png) Switch to the **PE Console** tab and log in with user `admin` and password `puppetlabs`.\n\n1. On the **Nodes** page, click the Windows node name to view the trusted facts for the new node.\n\n<br>\U0001F388 **Congratulations!** You uninstalled the Puppet agent from your Windows node and purged it from the primary server so that you can reuse its node license. You securely assigned the server's role and data center in your environment by installing the agent with trusted facts and provided an autosign password to enable certificate signing so that primary server can authenticate the agent.\n\nTo close this lab, click **Next**."
  tabs:
  - title: PE Console
    type: service
    hostname: puppet
    path: /
    port: 443
  - title: Linux Agent 1
    type: terminal
    hostname: nixagent1
  - title: Linux Agent 2
    type: terminal
    hostname: nixagent2
  - title: Primary Server
    type: terminal
    hostname: puppet
  - title: Windows Agent
    type: service
    hostname: guac
    path: /#/client/c/winagent?username=instruqt&password=Passw0rd!
    port: 8080
  - title: Lab Aid
    type: website
    hostname: guac
    url: https://puppet-kmo.gitbook.io/lab-aids/-MZKPjwKRKKFuXxxy7ge/pe101/establish-server-roles-by-reinstalling-agents-with-trusted-facts
  difficulty: basic
  timelimit: 3600
checksum: "8866184477091172421"
